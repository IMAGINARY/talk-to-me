<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Talk to Me</title>
    <link rel="stylesheet" type="text/css" href="../../node_modules/@fortawesome/fontawesome-free/css/all.css">
    <link rel="stylesheet" type="text/css" href="../../node_modules/bootstrap/dist/css/bootstrap-reboot.min.css">
    <link rel="stylesheet" type="text/css" href="../../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../css/circular-btn.css">
    <link rel="stylesheet" type="text/css" href="../css/style.css">
    <script>
        const assert = require('assert');
        const fs = require('fs').promises;
        const path = require('path');
        const EventEmitter = require('events');
        const ndarray = require('ndarray');
        const unpack = require('ndarray-unpack');
        const ops = require('ndarray-ops');
        const opsExt = require('../js/common/ndarray-ops-ext.js');

        const $ = require("jquery");
        const popper = require("popper.js");
        const bootstrap = require('bootstrap');

        const wav2letter = require("../js/common/wav2letter/wav2letter.js");
        const w2lUtils = require('../js/common/wav2letter/util.js');

        const MicrophoneFilterNode = require("../js/renderer/microphone-filter-node.js");
        const Recorder = require("../js/renderer/recorder.js");
        const WaveformVisualizer = require("../js/renderer/waveform-visualizer.js");
        const SpectrogramVisualizer = require("../js/renderer/spectrogram-visualizer.js");
        const TranscriptionVisualizer = require("../js/renderer/transcription-visualizer.js");

        Promise.all(['en', 'de'].map(lang => wav2letter.transcribe({waveform: new Float32Array(), lang: lang})))
            .then(() => console.log("Speech recognition models loaded."));

        async function init() {
            const audioContext = new AudioContext({sampleRate: 16000});
            const micInputNode = await Recorder.getMicrophoneAudioSource(audioContext);
            const recorderInputNode = new MicrophoneFilterNode(audioContext, {bypass: true});
            micInputNode.connect(recorderInputNode);

            const recorder = new Recorder({
                audioContext: audioContext,
                source: recorderInputNode,
                destination: audioContext.destination,
                duration: 2 * 1000 /* 2s */,
            });
            const samples = recorder.samples;

            const waveformVisualizer = new WaveformVisualizer(document.querySelector('#waveform-viz'), samples);
            const spectrogramVisualizer = new SpectrogramVisualizer(document.querySelector('#spectrogram-viz'));
            const transcriptionVisualizer = new TranscriptionVisualizer(document.querySelector('#transcription-viz'));

            function decodePredictionExt(predictionExt) {
                const letterActivations = predictionExt.layers[11];
                const decoded = wav2letter.decoder.decodeGreedyAll(letterActivations);
                const letterProbabilities = ndarray(new Float32Array(letterActivations.shape[0] * letterActivations.shape[1]), letterActivations.shape);
                opsExt.sigmoid(letterProbabilities, letterActivations);
                return {
                    indices: decoded,
                    probabilities: letterProbabilities,
                    alphabet: predictionExt.letters,
                };
            }

            samples.on('full', async data => {
                window.waveform = data;
                window.predictionExt = await wav2letter.predictExt({waveform: data, lang: language});
                spectrogramVisualizer.draw(window.predictionExt.logMelSpectrogram);
                const decodedPredictionExt = decodePredictionExt(window.predictionExt);
                transcriptionVisualizer.draw(
                    decodedPredictionExt.indices,
                    decodedPredictionExt.probabilities,
                    decodedPredictionExt.alphabet,
                    4
                );
            });

            function reset() {
                samples.clear();
                spectrogramVisualizer.clear();
                transcriptionVisualizer.clear();
            }

            const recordButton = $("#record-button");
            const playButton = $("#play-button");
            const restartButton = $("#restart-button");

            playButton.hide();

            samples.on('full', () => {
                recordButton.hide();
                playButton.show();
            });
            samples.on('empty', () => {
                playButton.hide();
                recordButton.show();
            });
            recorder.on('recording-stopped', () => recordButton.button('toggle'));
            recorder.on('playback-stopped', () => playButton.button('toggle'));

            recordButton.on('click', () => recorder.startRecording());
            playButton.on('click', () => recorder.startPlayback());
            restartButton.on('click', reset);

            let language = "en";
            const languageButton = $("language-button");
            $("#language-selector > a").on('click', e => {
                language = e.currentTarget.getAttribute("data-lang");
                reset();
            });
        }
    </script>
</head>
<body>
<div id="main">
    <div id="waveform">
        <div id="viz-container">
            <canvas id="transcription-viz" width="1024" height="72"></canvas>
            <br/>
            <canvas id="spectrogram-viz" width="1024" height="256"></canvas>
            <br/>
            <canvas id="waveform-viz" width="1024" height="256"></canvas>
        </div>
    </div>
    <div id="audio-controls">
        <button id="record-button" type="button" class="btn btn-secondary btn-circle btn-xl" data-toggle="button">
            <i class="fas fa-microphone fa-3x">
            </i>
        </button>
        <button id="play-button" type="button" class="btn btn-secondary btn-circle btn-xl" data-toggle="button">
            <i class="fas fa-play fa-2x"
               style="transform: translateX(0.225ex);">
            </i>
        </button>
        <button id="restart-button" type="button" class="btn btn-secondary btn-circle btn-xl">
            <i class="fas fa-redo-alt fa-2x">
            </i>
        </button>
    </div>
</div>
<div id="language-controls">
    <div class="btn-group dropup">
        <button id="language-button" type="button" class="btn btn-secondary btn-lg dropdown-toggle"
                data-toggle="dropdown"
                aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-language fa-lg"></i>
        </button>
        <div id="language-selector" class="dropdown-menu">
            <a data-lang="de" class="dropdown-item" href="#">Deutsch</a>
            <a data-lang="en" class="dropdown-item" href="#">English</a>
        </div>
    </div>
</div>
<script>
    init().then(() => console.log("Initialization complete"));
</script>
</body>
</html>
